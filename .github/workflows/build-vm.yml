# GitHub Actions Workflow for Building Ubuntu 22.04 VM with Packer

name: Build Ubuntu 22.04 VM

on:
  workflow_dispatch:  # Enables manual triggering from GitHub Actions UI

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Required to create releases and upload assets
    
    steps:
      # This downloads the repository files to the runner
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # VirtualBox is required for Packer to build virtual machines
      - name: Install VirtualBox
        run: |
          sudo apt-get update
          sudo apt-get install -y virtualbox
      
      # Packer is the tool that builds the VM from our configuration
      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: 'latest'
      
      # This downloads any required Packer plugins
      - name: Initialize Packer
        run: packer init ubuntu-22.04.pkr.hcl
      
      # This checks the .pkr.hcl file for syntax errors before building
      - name: Validate Packer template
        run: packer validate ubuntu-22.04.pkr.hcl
      
      # This is where Packer actually creates the virtual machine
      - name: Build VM with Packer
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“‹ IMPORTANT: The build includes a 15-25 minute SSH wait step"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "When you see: 'Waiting for SSH to become available...'"
          echo "This is EXPECTED while Ubuntu performs automated installation:"
          echo "  â€¢ Partitioning disk and installing packages"
          echo "  â€¢ Configuring users and SSH"
          echo "  â€¢ System finalization and reboot"
          echo ""
          echo "The process is NOT stuck - installation is running in the background!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          packer build ubuntu-22.04.pkr.hcl
      
      # This creates a new release and uploads the built VM as an asset (Always use "latest" tag - overwrites previous release)
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: Ubuntu 22.04 VM - Latest Build
          body: |
            # Ubuntu 22.04 Virtual Machine
            
            Automatically built with Packer on ${{ github.event.repository.updated_at }}
            
            ## Details
            - **OS**: Ubuntu 22.04 LTS Server
            - **Format**: OVA (VirtualBox VM, compressed in tar.gz)
            - **Build Date**: $(date +'%Y-%m-%d %H:%M:%S UTC')
            - **Triggered by**: @${{ github.actor }}
            
            ## How to Use
            1. Download the `ubuntu-22.04.tar.gz` file
            2. Extract: `tar -xzf ubuntu-22.04.tar.gz`
            3. Import the `.ova` file into VirtualBox or other virtualization platform
            4. For VirtualBox: Double-click the .ova file or use File â†’ Import Appliance
            
            ## Default Credentials
            - **Username**: ubuntu
            - **Password**: ubuntu
            - **Note**: Change the password after first login!
          draft: false
          prerelease: false
          files: |
            ubuntu-22.04.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
