# GitHub Actions Test Workflow for Building Ubuntu 22.04 VM on macOS
# This is a test workflow to validate that the Packer build works on macOS runners

name: Test Ubuntu 22.04 VM Build on macOS

on:
  workflow_dispatch:  # Enables manual triggering from GitHub Actions UI

jobs:
  test-macos-build:
    runs-on: macos-latest
    
    permissions:
      contents: write  # Required for uploading artifacts
    
    steps:
      # This downloads the repository files to the runner
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Check VirtualBox availability on macOS
      - name: Show VirtualBox version
        run: |
          which VBoxManage || echo "VBoxManage not found"
          VBoxManage --version || true
      
      # Packer is the tool that builds the VM from our configuration
      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: 'latest'
      
      # This downloads any required Packer plugins
      - name: Initialize Packer
        run: packer init ubuntu-22.04.pkr.hcl
      
      # This checks the .pkr.hcl file for syntax errors before building
      - name: Validate Packer template
        run: packer validate ubuntu-22.04.pkr.hcl
      
      # This is where Packer actually creates the virtual machine
      - name: Build VM with Packer
        env:
          PACKER_LOG: 1
          PACKER_LOG_PATH: packer.log
        run: packer build ubuntu-22.04.pkr.hcl
      
      # Upload packer.log for inspection (on success or failure)
      - name: Upload Packer logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: packer-logs
          path: packer.log
          retention-days: 7
      
      # Upload the built VM artifact for validation
      - name: Upload VM artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ubuntu-vm
          path: ubuntu-22.04.tar.gz
          retention-days: 7
